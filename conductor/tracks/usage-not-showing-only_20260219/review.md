# Code Review Report

**Branch:** `fix/usage-not-shown` vs `origin/develop`
**Generated:** 2026-02-19
**Track:** Usage Not Showing â€” Only Fallback '--'

---

## Summary

| Metric | Value |
|--------|-------|
| Files Changed | 15 |
| Lines Added | +647 |
| Lines Removed | -62 |
| **Code Quality** | ğŸ”´ High: 3 \| ğŸŸ¡ Medium: 7 \| ğŸŸ¢ Low: 4 |
| **Security** | ğŸ”´ High: 0 \| ğŸŸ¡ Medium: 3 \| ğŸŸ¢ Low: 5 |
| **Test Coverage** | ğŸ”´ High: 1 \| ğŸŸ¡ Medium: 3 \| ğŸŸ¢ Low: 3 |

---

## Code Quality

### High Severity

1. **Hardcoded API URL** (`main.go:59`) â€” The Anthropic API URL is inline in a goroutine. The same class of bug caused this track. Extract to a named constant.

2. **Hardcoded version string** (`client.go:57`) â€” `"conductor-powerline/1.0.0"` in User-Agent header will go stale. Extract to a constant.

3. **Mutable package-level state in debug** (`debug.go:9`) â€” `enabled` and `output` are global vars. Consider a `Logger` struct for concurrency safety.

### Medium Severity

1. **Repeated JSON unmarshaling** (`hook.go:69`) â€” `ModelID()` and `WorkspacePath()` re-run `json.Unmarshal` on every call. Resolve once in `UnmarshalJSON`.
2. **Deprecated shims remain exported** (`hook.go:62`) â€” `Model()` and `Workspace()` have no removal plan.
3. **Magic prefix heuristic** (`keychain.go:35`) â€” `"sk-ant-oat"` prefix check is fragile for raw-token fallback.
4. **Silent time parse errors** (`client.go:91,96`) â€” `time.Parse` errors discarded with `_`. At least log via debug.
5. **Consecutive debug logs** (`usage.go:23-25`) â€” Two logs with no intervening logic could be merged.
6. **Missing doc comment** (`credfile.go:32`) â€” `claudeAiOAuthEntry` lacks documentation.
7. **Struct alignment** (`client.go:45`) â€” `SevenDaySonnet` field tag alignment inconsistent.

### Low Severity

1. `os.Unsetenv` in test instead of `t.Setenv` (`debug_test.go:43`)
2. Empty `platformName` on unsupported OS (`oauth.go:40`)
3. Silent error discard on `themes.Get` lacks comment (`main.go:50`)
4. `"GET"` literal should be `http.MethodGet` (`client.go:51`)

---

## Security Analysis

### Critical/High Severity

No security vulnerabilities detected.

### Medium Severity

1. **Token length logged to stderr** (`oauth.go:46`, `usage.go:23`) â€” When `CONDUCTOR_DEBUG=1`, token length is emitted. Remove token-derived metadata from logs; log only success/failure booleans.
2. **Test normalizes token logging pattern** (`debug_test.go:63`) â€” Test asserts on a token-like string in output, establishing a risky pattern for future developers.
3. **No response body size limit** (`client.go:73`) â€” `io.ReadAll` with no bound on API response. Add `io.LimitReader(resp.Body, 64*1024)`.

### Low Severity

1. Default TLS config (acceptable, Go defaults are TLS 1.2+)
2. Raw token prefix check lacks CRLF validation (`keychain.go:35`)
3. Full workspace path logged in debug mode (`main.go:38`)
4. Full config logged in debug mode (`main.go:47`)
5. These are acceptable for an opt-in debug mode but worth noting

---

## Test Coverage

### Coverage by Package

| Package | Coverage | Status |
|---------|----------|--------|
| config | 92.2% | âœ… |
| debug | 100.0% | âœ… |
| hook | 84.4% | âœ… |
| oauth | 81.0% | âœ… |
| render | 100.0% | âœ… |
| segments | 92.3% | âœ… |
| themes | 100.0% | âœ… |
| main | 0.0% | âš ï¸ (subprocess tests) |

### Coverage Gaps

1. **main.go at 0%** (high) â€” Integration tests use `exec.Command` so Go's coverage tool can't instrument. Consider making `run()` directly testable.
2. **Deprecated shims uncovered** (medium) â€” `Model()` and `Workspace()` in hook.go never called in tests.
3. **Keychain error path** (medium) â€” Non-JSON, non-token keychain data path untested.
4. **`defaultCredfilePath()` uncovered** (low) â€” Real path resolver bypassed by mock in all tests.

---

## Recommendations

**Priority Actions (address before merging):**
1. Extract API URL to a named constant in `main.go` â€” prevents repeat of the root cause bug class
2. Add `io.LimitReader` to `client.go` response body reading â€” prevents memory exhaustion

**Suggested Improvements:**
1. Remove token-length from debug logs (log success/failure only)
2. Resolve `ModelID()`/`WorkspacePath()` once during unmarshal instead of per-call
3. Extract version constant for User-Agent header
4. Add test for keychain non-JSON, non-token error path
5. Use `http.MethodGet` instead of string literal

---

*Auto-review generated by `/conductor:implement` on track completion*
