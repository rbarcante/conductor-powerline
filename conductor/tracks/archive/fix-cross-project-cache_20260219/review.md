# Code Review Report

**Branch:** `bugfix/cache-cross-project-fix` vs `origin/develop`
**Generated:** 2026-02-19
**Track:** Fix cross-project cache contamination

---

## Summary

| Metric | Value |
|--------|-------|
| Files Changed | 9 |
| Lines Added | +532 |
| Lines Removed | -174 |
| **Findings** | ðŸ”´ High: 4 \| ðŸŸ¡ Medium: 9 \| ðŸŸ¢ Low: 8 |

---

## Code Quality

### High Severity

1. **filecache.go:59** â€” `cleanup()` runs synchronously on every `Store()`, adding an `os.ReadDir` + stat loop to the hot path. Consider `go fc.cleanup()` for async cleanup.

2. **filecache.go:55** â€” `os.WriteFile` is not atomic. Concurrent shell tabs could corrupt the JSON. Recommend write-then-rename pattern (`os.CreateTemp` + `os.Rename`).

### Medium Severity

1. **filecache.go:18** â€” TTL field stored in JSON but never read back; decorative and misleading.
2. **filecache.go:80** â€” `os.Remove()` error silently discarded; inconsistent with debug logging elsewhere.
3. **usage.go:14** â€” UsageCache interface doc references deleted in-memory Cache type.
4. **usage.go:32** â€” FetchUsage always calls API; no cache-first read for non-stale entries.
5. **main.go:60** â€” WaitGroup + single goroutine provides no actual parallelism; segment building waits for fetch to complete.
6. **main.go:60** â€” usageData written in goroutine by closure reference; fragile if refactored.
7. **git_test.go:103** â€” capturedArgs flattened across calls; -C assertion not per-invocation.

### Low Severity

1. **filecache_test.go:165** â€” Error return from `os.ReadDir` and `os.Chtimes` ignored in tests.
2. **filecache.go:30** â€” Missing doc about graceful degradation behavior on dir creation failure.
3. **filecache.go:88** â€” Local variable `path` shadows `path/filepath` import name.
4. **main.go:45** â€” `filepath.Join(".", ...)` is redundant.

---

## Security Analysis

### Critical/High Severity

No critical or high severity security vulnerabilities detected.

### Medium Severity

No medium severity security issues found.

### Low Severity

1. **git.go:54** â€” Workspace path from stdin passed to `git -C`. exec.Command arg slice prevents shell injection, but a path starting with `--` could be interpreted as a git flag. Mitigated by Claude Code being the input source.
2. **main.go:144** â€” `$XDG_CACHE_HOME` used without validation. A hostile env could redirect cache writes.
3. **filecache.go:97** â€” Workspace path logged verbatim in debug output (minor path disclosure).
4. **filecache.go:79** â€” Cleanup uses mtime which may not be reliable after backup restoration.

---

## Test Coverage

### Coverage Results

| File | Function | Coverage |
|------|----------|----------|
| git.go | Git() | 100% |
| git.go | gitArgs() | 100% |
| filecache.go | NewFileCache | 100% |
| filecache.go | Store | 75% |
| filecache.go | cleanup | 72.7% |
| filecache.go | Get | 83.3% |
| filecache.go | keyPath | 100% |
| usage.go | FetchUsage | 100% |
| **oauth package** | **overall** | **79.6%** |

### Coverage Gaps

1. **filecache.go Store()** (75%) â€” marshal error branch unreachable with current types.
2. **filecache.go cleanup()** (72.7%) â€” `IsDir()` guard and `e.Info()` error path untested.
3. **filecache.go Get()** (83.3%) â€” corrupt file / unmarshal error branch untested.
4. **main.go cacheDir()** â€” XDG/fallback branches not unit-tested.

### Missing Tests

All changed files have corresponding test files. No missing test files.

---

## Recommendations

**Suggested Improvements:**
1. Make cleanup async (`go fc.cleanup()`) to avoid blocking the statusline render path
2. Add atomic write (temp file + rename) to prevent corrupt cache from concurrent invocations
3. Add cache-first read in FetchUsage to skip API when non-stale data exists
4. Update stale UsageCache doc comment referencing deleted Cache type
5. Add corrupt-file test for Get() to close the 83.3% gap

**Note:** All findings are non-blocking suggestions. The implementation is functionally correct and all tests pass.

---

*Auto-review generated by `/conductor:implement` on track completion*
