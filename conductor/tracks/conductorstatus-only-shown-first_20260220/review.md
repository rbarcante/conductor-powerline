# Code Review Report

**Branch:** `feature/conductor-status-line1-only` vs `origin/main`
**Generated:** 2026-02-20
**Track:** conductorStatus must only be shown in the first line if not installed

---

## Summary

| Metric | Value |
|--------|-------|
| Files Changed | 25 |
| Lines Added | +1354 |
| Lines Removed | -85 |
| **Findings** | ðŸ”´ High: 0 \| ðŸŸ¡ Medium: 13 \| ðŸŸ¢ Low: 14 |

---

## Code Quality

### High Severity
No high severity issues found.

### Medium Severity
- **main.go:70** â€” Goroutines write to shared `usageData`/`workflowData` without explicit synchronization beyond `wg.Wait()`. Pattern is correct but fragile. Suggestion: use channels to return goroutine results.
- **workflow_cli.go:55** â€” Package-level mutable `execCommandFunc` is not safe for parallel tests (data race if `t.Parallel()` is used). Suggestion: inject command factory via struct.
- **workflow.go:55** â€” `nerdFonts` parameter in `WorkflowTasks()` and `WorkflowOverall()` is accepted but never used (dead code). Suggestion: remove until implemented.
- **workflow.go:35** â€” `selectActiveTrack()` called redundantly by multiple segment builders per render cycle. Suggestion: compute once in `buildWorkflowSegments()` and pass down.
- **workflow.go:84** â€” Magic strings `"in_progress"` and `"completed"` used without named constants. Suggestion: define `TrackStatusInProgress` / `TrackStatusCompleted`.
- **main.go:48** â€” `os.UserHomeDir()` called three times across `run()`. Suggestion: call once and thread through.

### Low Severity
- **workflow_cli.go:75** â€” Comment says glob returns sorted paths for highest version but lexicographic order breaks for multi-digit semver components.
- **workflow.go:120** â€” `UpdatedAt` string comparison fragile for non-ISO 8601 formats.
- **workflow.go:13** â€” No defensive fallback when theme segment key missing (e.g., `workflow_setup`).
- **workflow_cli.go:16** â€” `data.Tracks.Tracks` double nesting is ergonomically awkward.
- **workflow_cli_test.go:73** â€” `cat` command used in test helper not available on Windows CI.
- **workflow_cli_test.go:1041** â€” `sleep 10` used in timeout test not available on Windows CI.
- **main_test.go:277** â€” Missing test case: ConductorActive with CLI failure (nil workflowData) should still produce single-line output.

---

## Security Analysis

### Critical/High Severity
No security vulnerabilities detected.

### Medium Severity
- **workflow_cli.go:92** â€” Workspace path from stdin JSON passed to subprocess without validation. Mitigated by `exec.CommandContext` discrete args (no shell injection), but a crafted path could redirect CLI to unintended directories. Suggestion: validate `workDir` is absolute path.
- **workflow_cli.go:69** â€” Glob-discovered script path executed without integrity check. If attacker can write to `~/.claude/plugins/cache/`, lexicographic sort could select malicious version. Suggestion: validate version pattern or pin expected version.
- **workflow_cli.go:54** â€” Mutable package-level test seam (`execCommandFunc`) not safe for parallel tests.

### Low Severity
- **workflow_cli.go:90** â€” Debug logging exposes filesystem paths (acceptable, gated behind env var).
- **main.go:85** â€” Shared goroutine variable pattern is correct but fragile (same as code quality finding).
- **main.go:60** â€” `os.Getwd()` / `os.UserHomeDir()` errors silently discarded. Suggestion: log via `debug.Logf`.

---

## Test Coverage

All changed files have corresponding test files. No files without tests.

### Coverage Gaps (Medium)
- `buildRightSegments()` Enabled-check path not unit-tested for Active/Installed states
- `buildWorkflowSegments()` has no direct unit test (only integration test)
- Line 2 visibility when CLI fails (ConductorActive + nil workflowData) not tested
- `WorkflowSetup` with `IsValid=false, SetupComplete=true` not tested

### Coverage Gaps (Low)
- `FindConductorCLI("")` empty homeDir fallback not tested
- `FindConductorCLI` multiple version directories selection not tested
- Disabled conductor segment fields (Text, FG, BG) not asserted as empty for Active/Installed
- `selectActiveTrack` with single non-in_progress track not tested

---

## Recommendations

**Priority Actions (address before merging):**
None â€” no high severity issues found.

**Suggested Improvements:**
1. Add unit tests for `buildRightSegments()` covering Active/Installed (excluded) and None/Marketplace (included)
2. Add unit test for `buildWorkflowSegments()` verifying 4 segments in correct order
3. Define named constants for track status strings (`"in_progress"`, `"completed"`)
4. Remove unused `nerdFonts` parameter from `WorkflowTasks`/`WorkflowOverall`
5. Fix Windows CI compatibility: replace `cat`/`sleep` with cross-platform equivalents in tests

---

*Auto-review generated by `/conductor:implement` on track completion*
